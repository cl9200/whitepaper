# 메디블록 기술 백서 v0.2

## 개요

메디블록의 헬스케어 데이터 플랫폼은 환자를 중심으로 헬스케어 데이터의 관리 및 교류가 이루어지는 생태계를 조성한다. 여기에 필수적으로 요구되는 데이터의 무결성과 소유권 검증이 조작에 대한 의심 없이 이루어질 수 있도록, 블록체인 기술을 플랫폼 내에 핵심 컴포넌트로 활용한다. 블록체인은 암호학적 서명을 포함한 거래 내역을 저장하는 공유 장부로, 다수의 합의를 바탕으로 내용을 추가, 검증하기 때문에 한 번 성공적으로 기록된 내용은 실질적으로 거의 조작이 불가능하다는 특성을 갖는다. 이 점을 활용해 비트코인과 같은 암호화폐 기능 뿐만 아니라, 데이터의 해시 값을 통한 무결성 검증 및 데이터 소유권 검증이 분명하게 이뤄지도록 한다. 또한, 블록체인이 제공하는 기본적인 기능에 더해 의사, 환자, 의료 연구자에게 모두 이익이 발생하는 선순환 고리가 효과적으로 형성되도록 의료인 검증, 데이터 중계, 백업 및 데이터 거래에 따른 보상체계 등이 블록체인을 기반으로 한 별도의 서비스들을 통해 제공된다.
위에서 언급한 메디블록 플랫폼의 기능을 SDK의 형태로 공개 및 배포해 써드파티 개발자들이 자신의 애플리케이션이나 서비스에서 손쉽게 활용할 수 있도록 한다.

## 블록체인

### 합의 방식(Consensus mechanism)

메디블록의 블록체인은 DPOS(Delegated Proof of Stake) 합의 방식을 사용한다. DPOS의 가장 큰 장점은 뛰어난 처리량(Transactions per second)이다. DPOS 방식에서는 사용자들의 투표로 결정된 소수의 블록생성자가 효율적으로 블록 동기화를 하면서 빠른 속도로 새 블록을 생성할 수 있다.
DPOS 방식의 세부적인 사항은 이 방식의 선구자라고 할 수 있는 스팀(Steem)과 EOS.IO의 구현 방식을 참고하였으며, 메디블록만의 특수한 사용 환경에 맞추는 과정에서 추후 변동의 여지가 있다. 메디블록의 블록체인에서 블록생성자 집단은 투표를 통해 정해지는 상위 21명으로 이루어진다. 라운드마다 선출된 21명이 각각의 계정 주소에 기반해서 정해진 순서에 따라 3초에 하나씩 블록을 생성하며, 블록의 사이즈에는 제한이 없다. 대신 트랜잭션의 사이즈에 제한이 존재하는데, 주어진 블록 생성 시간 안에 너무 많은 트랜잭션을 처리하려다 미처 블록을 생성하지 못하고 블록 생성 권한이 다음 순서의 블록생성자에게 넘어가게 될 경우, 이전 블록생성자는 블록 생성 보상을 얻지 못해 손해를 입는 셈이 된다. 따라서 블록생성자 입장에서는 주어진 시간 동안 실행, 검증이 가능한 분량의 트랜잭션만 블록에 포함하려고 할 것이고, 트랜잭션 각각에 대해서는 사용자들이 경제적인 대가를 지불하기 때문에 블록의 사이즈가 악의적인 의도에 의해 지나치게 크게 형성될 우려는 없다.
메디블록의 블록체인에서 발생하는 연간 인플레이션 비율은 5%이며, 이는 모두 블록생성자들에게 블록 생성 보상으로 주어진다.

### 사용량 대여 모델(Usage rental model)

통상적인 데이터베이스나 스토리지 서비스와 달리, 블록체인은 매우 비싼 저장 공간이다. 블록체인에 한 번 기록된 내용은 전 세계의 블록체인 노드에게 전파되며, 각각의 노드는 이 내용이 블록체인에 저장되는 것이 올바른가를 검증하는 과정을 거친다. 일단 한 번 기록한 내용은 지우거나 수정할 수 없어 기록할 당시의 형태 그대로 블록체인에 남기 때문에, 최대한 네트워크에 실질적인 가치를 더하는 기록으로만 블록체인 장부를 채우는 것이 중요하다.
이를 위해 가장 널리 쓰이는 방법은 트랜잭션 건마다 수수료를 부과하는 것(pay-per-transaction)이다. 비트코인, 이더리움 등의 블록체인들은 그 자체가 화폐를 구현하고 있기 때문에 이 방법이 가능한데, 새 트랜잭션을 반영시킬 때마다 암호화폐를 수수료로 지불하게 함으로써 누군가 블록체인을 무의미한 데이터로 가득 채우기 위해서는 상당한 금전적 대가를 치르게 만드는 것이다.
이 수수료 방식은 블록체인이라는 한정된 자원에 대한 오남용을 효과적으로 막아줄 수 있다. 하지만 블록체인의 상태(States)를 변경시키는 모든 행동에 대해 지속적으로 수수료가 부과된다는 점이 사용자들에게 있어 이를 기반으로한 서비스로의 접근을 어렵게 만드는 현실적인 장벽이 되기도 한다. 블록체인을 기반으로 사용자들이 자주 사용하는 서비스를 구현하기 위해서는 이와는 다른 접근이 필요하다. 블록체인 커뮤니티에서 여러 대안들이 제시되었으며, 그 중 메디블록이 부분적으로 채택하고자 하는 방식은 대역폭 모델(Bandwidth model)이다. 대역폭 모델의 기본적인 개념은 사용자로 하여금 해당 블록체인 네트워크의 암호화폐를 예치(Staking) 하도록 하고, 그 양에 따른 지분율을 바탕으로 전체 트랜잭션 처리량 중 일부를 사용할 수 있도록 하는 것이다. 따라서 사용자는 이미 정해진 타임 윈도우(Time window) 안에서 자신이 트랜잭션을 얼마나 사용할지에 따라 그에 맞는 양의 암호화폐를 예치함으로써 블록체인을 사용할 수 있게 된다. 블록체인을 사용하지 않을 때는 예치금을 다시 인출할 수 있다.

| ![Image of Time window](https://github.com/medibloc/whitepaper/blob/master/images/TimeWindow.png) |
|:--:|
| *Time window* |

대역폭 방식은 지속적인 비용 지출이 없도록 함으로써 사용자들의 서비스 진입 장벽을 낮출 수 있을 것으로 기대될 뿐만 아니라 블록체인을 사용하기 위해 특정 암호화폐를 지속적으로 구입해야 하는 불편함을 없앤다. 하지만 위와 같은 단순 대역폭 모델에서는 블록체인 네트워크를 이용하기 위해 각 사용자가 필요량 이상의 암호화폐를 반드시 보유해야만 한다. 그리고 이를 위해서는 해당 암호화폐를 구입할 수 있는 거래소를 거쳐야 하는 등 다소 불편한 과정이 요구되기 때문에 실제 상용 서비스를 제공하는 과정에서 적지 않은 걸림돌이 될 것으로 생각된다.
이 문제를 해결하기 위해 메디블록은 “사용량 대여 모델”이라는 개념을 도입한다. 이 모델에서는 블록체인에 대한 일정량의 사용 권한(e.g. 대역폭)을 가진 사람이 타인의 트랜잭션을 대신 처리해줄 수 있다. 이를 위해 트랜잭션에는 2차 서명, 혹은 지불자 서명(Payer signature)이라는 새로운 필드가 존재한다. 지불자 서명은 선택적으로 입력하는 필드이며, 만약 지불자 서명이 존재하는 상태로 트랜잭션이 제출되면 블록 생성자는 1차 서명자가 아닌, 2차 서명자가 가지고 있는 사용 권한을 기준으로 트랜잭션 처리 여부를 결정한다. 이에 따라 2차 서명자의 트랜잭션 사용 현황에 자신이 지불자 서명을 넣어줬던 트랜잭션 사용 내역이 반영되며, 그만큼 사용 가능한 대역폭을 소모하게 된다.
사용량 대여 모델 상에서 메디블록 기반의 서비스 제공자는 자신이 많은 양의 암호화폐를 예치하여 서비스 사용자의 트랜잭션에 2차 서명을 붙여줄 수 있고, 여기에 일정량의 과금을 할 수도 있다. 2차 서명을 누구에게 얼마나 해줄지에 대한 정책은 서비스 제공자의 정책을 통해 결정되며, 메디블록에서 이 방식에 대해 어떠한 강제를 하지는 않는다.

| ![Image of Rental model](https://github.com/medibloc/whitepaper/blob/master/images/RentalModel.png) |
|:--:|
| *Usage rental model* |

사용량 대여 모델의 기본 원리에 해당하는 개념은 대역폭 모델 뿐만 아니라 수수료 모델에도 적용이 가능하다. 이럴 경우 2차 서명자는 사용 권한을 “대여”한다기보다는 수수료를 “대납”한다는 표현이 올바를 것이다. 수수료 대납 모델은 사용량 대여 모델과 비교했을 때 여러가지 장단점을 가질 수 있다. 메디블록은 사용량 대여 모델과 수수료 대납 모델 중에서 대역폭 모델에 기반한 사용량 대여 모델을 채택하였는데, 수수료 대납 모델에서는 2차 지불자가 대납을 해줄 때마다 보유하고 있는 암호화폐 수가 감소하기 때문에 2차 지불 서비스의 안전성이나 유지 간편성까지 고려했을 경우 사용량 대여 모델이 더 낫다고 판단했기 때문이다.
메디블록의 사용량 대여 모델에서 사용 권한은 대역폭 모델의 대역폭과 동일하게 계산하며, 사용자가 원한다면 사용량을 대여받지 않아도 자신이 직접 암호화폐를 예치하여 일정량의 대역폭을 할당 받을 수 있다. 대역폭은 7일 동안 사용 가능한 트랜잭션 수를 사용자의 예치금 양 및 7일 동안의 트랜잭션 최대 처리량으로부터 계산하여 구하며, 사용자가 트랜잭션을 발생시킨 후 7일의 시간이 지나면 해당 트랜잭션을 발생시키기 위해 사용했던 대역폭이 회복되는 방식이다.

### 헬스케어 데이터 머클 트리(Merkle tree of healthcare data)

메디블록 플랫폼 내에서 헬스케어 데이터는 머클 트리(Merkle tree)의 형태로 가공되어 관리된다. 특정 형식의 헬스케어 데이터(e.g. HL7 FHIR)를 머클 트리로 만드는 과정은 해당 데이터 형식을 사용하는 서비스가 지원해야 하며, 메디블록은 이것을 쉽게 구현할 수 있도록 소프트웨어 도구와 가이드라인을 제공한다.

| ![Image of Merkle tree](https://github.com/medibloc/whitepaper/blob/master/images/MerkleTree.png) |
|:--:|
| *HL7 FHIR to merkle tree* |

데이터를 머클 트리 형태로 관리할 때의 장점은 데이터 내용을 일부만 공유하는 것이 가능하다는 점이다. 블록체인에는 데이터 소유자가 머클 트리의 루트 해시(Root hash)를 기록한다. 머클 트리의 특성 상 데이터의 일부만 공개하더라도 루트 해시를 포함하는 머클 증명(Merkle proof)을 제공하면 그것이 전체 원본에 포함된 값이 맞는지 검증이 가능하다. 이를 이용해 데이터 전달시에 개인 정보를 제외함으로써 데이터를 비식별화 하는것도 가능하며, 요청자의 요구에 따라 작성자의 서명과 같은 특정 데이터만을 공개해 데이터 거래 전에 해당 데이터에 대한 신뢰성을 먼저 입증할 수 있다.
머클 트리로 변환된 데이터 원본은 1차적으로 사용자의 스마트폰 디바이스에 저장된다. 블록체인에는 데이터 원본을 바탕으로 추출한 루트 해시를 기록하기 때문에 데이터 저장 및 공유 과정에서 사용하는 암호화 방식에도 아무런 제약이 없다. 컴퓨팅 파워의 증가로 인해 원래의 암호화 방식이 안전성을 잃더라도 블록체인에 기록된 내용과 충돌하는 것 없이 서비스 단계에서 새로운 암호화 방식을 적용할 수 있다.

### 의료인 검증(Certification of healthcare professionals)

의료인에 대한 자격 검증은 현재 국가별/지역별로 각기 다른 방식을 취하고 있다. 게다가 많은 경우 자동화된 검증 시스템이 구축되어 있지 않기 때문에 서로 다른 이들 시스템을 모두 포괄하는 하나의 공통된 자격 검증 시스템을 구축 하는 것은 굉장히 어렵다. 따라서 메디블록은 하나의 공통된 자격 검증 시스템을 구축하지 않고 탈중앙화된 방식으로 지역/국가마다 하나 이상의 자격 검증 서비스가 메디블록 플랫폼 위에서 제공되는 것을 허용한다. 의료인에 대한 자격 검증은 '인증 주체'와 '인증 대상'을 동시에 블록체인에 기록으로 남기는 것으로 이루어진다. 이렇게 남겨진 기록은 사용자들이 쉽게 확인할 수 있으며 '인증 주체'에 따라 검증 결과의 신뢰도가 달라질 수 있다.

| ![Image of Certification](https://github.com/medibloc/whitepaper/blob/master/images/Certification.png) |
|:--:|
| *Certifications on the blockchain* |

어떤 계정이 의료인이라는 것에 대한 인증은 해당 정보를 포함하는 트랜잭션을 블록체인에 기록함으로써 이루어지며, 누구나 인증 행위를 할 수 있다. 메디블록 플랫폼 사용자들은 자기가 의료인이라고 주장하는 사람이 어떤 인증 주체로부터 의료인 인증을 받았는지 블록체인 상에서 확인하여 실제 의료인이 맞다고 믿을지 결정한다. 이를 위해 알려진 공개키를 사용하여 의료인 인증을 수행하는 인증 서비스가 플랫폼 상에 존재해야 한다. 의료인 인증 서비스에 대해서는 뒤에서 한 번 더 다룰 것이다.
블록체인 상에서는 다양한 인증 주체가 활동할 수 있겠지만, 사용자들이 매번 애플리케이션 화면 상에 표시되는 인증 주체 여럿을 두고 믿을지 말지 결정해야 한다는 것은 아니다. 특정 지역 내에서 믿을 수 있는 인증 서비스의 알려진 공개키 정보를 바탕으로, 애플리케이션 또는 서비스 레벨에서 의료인 인증 여부를 보다 명확하게 판단하여 사용자에게 표시할 수 있기 때문이다.
의료인 인증 트랜잭션에는 인증 서비스에서 의료인에게 발급하는 인증서의 해시 및 유효기간도 포함된다. 이 인증서에는 의료인에 대한 보다 상세한 정보(e.g. 전공 분과, 소속 병원 등)가 기록되어 있으며, 의료인이 환자에게 진단 데이터를 전송할 때 해당 데이터에 포함되어 전달된다.

### 토큰 예치 및 인출

토큰을 더 많이 예치할수록 예치금에 비례해서 DPOS 투표의 영향력과 블록체인 네트워크에서 할당 받는 대역폭이 증가한다. 반대로 인출하면 예치금이 감소한 만큼 투표 영향력과 사용 가능한 네트워크 대역폭이 줄어든다. 토큰 예치는 트랜잭션만 발생시키면 즉각적으로 이뤄지며, 인출의 경우엔 인출 신청 트랜잭션을 발생시키고 정확히 7일이 지나야 계정의 잔액에 인출 금액이 추가가 된다. 이에 반해 투표 영향력 및 네트워크 대역폭 할당량은 인출 신청 즉시 감소하는데, 인출 신청 자체가 해당 권한에 대한 포기 선언이나 다름없기 때문이다. 인출이 오래 걸리는 이유는 누군가 단기적인 이득을 취하고 바로 빠져나갈 목적으로 메디블록 플랫폼에 참여하는 것을 막고, 다수의 계정으로 암호화폐를 이동시키면서 예치와 인출을 반복하는 식의 DoS 공격을 방지하기 위함이다.

### 스마트 컨트랙트

메디블록의 블록체인은 위에서 설명한 여러 기능을 지원할 수 있도록 미리 정해진 형식을 따르는 복수의 트랜잭션 타입을 지원한다. 사용자가 임의로 데이터 저장 및 변경 방식을 정의하면 그에 맞는 트랜잭션 형식을 지원하는, 소위 ‘스마트 컨트랙트’ 기능은 초기 버전에서 지원하지 않는다. 다만, 메디블록 플랫폼에서 다양한 헬스케어 데이터 기반 애플리케이션들이 동작할 수 있도록 향후 스마트 컨트랙트 엔진(e.g. EVM)을 도입하는 방안에 대해서는 지속적으로 검토가 이루어질 예정이다.

## 서비스

### 의료인 인증 서비스

블록체인 상에 의료인에 대한 인증 내역을 기록하는 주체는 플랫폼 참여자들이 믿을 수 있는 존재여야 한다. 기본적으로 누구나 인증자의 역할을 할 수 있지만, 플랫폼 초기에는 메디블록이 직접 개발, 운영하는 의료인 인증 서비스가 이 역할을 수행하도록 한다. 메디블록 플랫폼에 참여하고자 하는 의료인들은 이 서비스에 회원가입을 하고 필요한 증명 서류를 제출하여 검증 프로세스를 거친다. 검증을 통해 적법한 전문 의료인임이 확인되면 인증 서비스는 해당 의료인에 대한 인증서를 발급하고, 이에 대한 일부 정보를 블록체인 상에 트랜잭션 형태로 기록한다. 여기엔 발급한 인증서의 해시 및 유효기간이 포함되며, 인증 서비스는 다른 사용자의 요청이 있을 경우 해당 인증서 내용을 제공해주는 역할도 한다.

![Image of Certification process](https://github.com/medibloc/whitepaper/blob/master/images/CertificationProcess.png) |
|:--:|
| *Certification process* |

혹시 이미 인증서를 발급 받은 한 의료인이 어떠한 이유로 의료인의 자격을 상실하게될 경우엔 해당 인증서를 폐기한다는 기록을 블록체인에 남겨 플랫폼 참여자들이 확인할 수 있도록 한다. 플랫폼의 사용자가 증가하고 사용 지역이 확대되면서 메디블록이 직접 운영하는 인증 서비스 뿐만 아니라 여러 개의 신뢰받는 의료인 인증 서비스가 공존하며 인증 서비스를 제공할 수 있다.

### 데이터 중계 및 백업 서비스

헬스케어 데이터가 개인의 디바이스에만 저장되면 기기 분실 또는 변경 시에 유실의 위험이 있다. 또한, 데이터 제공의 측면에서도 사용자가 직접 P2P로 자신의 데이터를 전송해야 할 경우엔 디바이스의 네트워크 환경에 따라 사용자 경험의 품질에 큰 차이가 생길 수 있다. 이러한 점을 보완하기 위해 데이터 전달을 중계하고 2차 백업 저장소의 역할을 하는 서비스가 필요하다. 이 서비스는 기본적으로 데이터가 작성된 전문 의료기관에서 사용자로, 다시 사용자로부터 그가 데이터 공유를 원하는 타인에게 데이터가 원활하고 안전하게 전달될 수 있도록 중계를 담당하는 역할을 한다. 이 과정에서 데이터는 보낸 사용자와 받는 대상만이 내용을 조회할 수 있도록 본문을 대칭키 암호화(Block encryption)하고, 대칭키를 다시 전달 받는 쪽에서만 풀어볼 수 있는 방식으로 암호화하여 전달한다. 데이터 암호화 키를 암호화하기 위해서는 메디블록 블록체인에서 사용하는  타원곡선 키쌍을 활용한 Elliptic-curve Diffie Hellman(ECDH) 기법을 사용한다. 여기에 더해, 사용자가 원한다면 본인만 풀어볼 수 있도록 암호화하여 데이터를 백업해둘 수 있다. 이럴 경우 데이터 공유가 필요할 때마다 사용자가 중계 서버에 데이터를 전체를 전송할 필요 없이, 데이터를 받는 입장에선 암호화된 데이터를 백업 서비스로부터 다운로드 받고, 사용자는 중계 서비스를 통해 데이터를 복호화할 수 있는 키만 비대칭 암호화하여 전달하면 된다.

| ![Image of Data relay](https://github.com/medibloc/whitepaper/blob/master/images/DataRelay.png) |
|:--:|
| *Data transfer* |

또한, 사용자가 거래 목적으로 헬스케어 데이터의 특정 영역(e.g. 의료인 서명)을 공개하고자 할 경우, 누군가 요청할 때마다 전송하는 것보다 데이터 백업 서비스에 보관하고 공개해 놓는 것이 효율적일 것이다. 마찬가지로 머클 증명의 경우 데이터 백업 서비스에 머클 트리를 저장해 놓으면 데이터를 전달 받은 사용자가 언제든 머클 트리를 내려받아 진본 증명을 해볼 수 있다.

### 데이터 마켓 서비스

데이터 마켓은 플랫폼 내 서비스 형태로 플랫폼 사용자들에게 제공되며, 원하는 사용자들은 마켓에 자신이 소유한 데이터의 일부 내용을 공개함으로써 데이터 판매자로 참여할 수 있다. 데이터 구매자는 자신이 원하는 데이터의 특정 필드 값을 설정해, 해당 쿼리에 부합하는 데이터를 소유한 사람이 머클 증명과 함께 데이터 거래를 제시할 수 있도록 한다. 양쪽의 합의 하에 거래가 성사되면 암호화 통신으로 데이터 원본의 일부 또는 전체와 그에 해당하는 머클 증명이 구매자에게 전달되고, 전달된 머클 증명과 블록체인 상에 기록된 루트 해시를 바탕으로 데이터가 진본임이 증명되면 거래 대금에 해당하는 토큰의 송금이 이뤄져 거래가 성사될 수 있다.

## 프라이버시 보호

헬스케어 데이터의 관리에 있어서 강도 높은 프라이버시 보호는 필수적으로 요구된다. 메디블록 플랫폼 상에서 헬스케어 데이터가 새로 생성 및 기록될 때마다 그것이 누구로부터 어떤 경위에서 발생한 내역인지 유추가 불가능하도록, 데이터의 이동 내역이나 작성자의 정보는 블록체인 상에 기록하지 않는다. 작성자에 대한 정보는 데이터 원본에 포함되어 머클 트리를 구성할 때 포함되며, 블록체인에는 머클 트리의 루트 해시만 저장되기 때문에 공개된 데이터로부터 작성자 정보를 유추하는 것은 불가능하다. 대신 데이터의 원본 내용에 포함된 작성자 정보를 직접 사용자로부터 전달 받아 가지고 있는 사람은 작성자 정보를 포함하는 머클 트리를 만들어내어 작성자 정보가 조작된 것이 아닌지 검증할 수 있다. 또한, 데이터의 이동은 데이터 중계 서비스를 통해 블록체인과 별도로 이뤄지기 때문에 공개된 정보를 가지고 추적을 할 수 없으며, P2P 방식이든 데이터 중계 서비스를 이용한 방식이든 중간에 가로챈 데이터는 원본의 주인과 받을 대상만 풀어볼 수 있도록 암호화되어 있기 때문에 유출의 위험도 없다.
데이터 거래에 있어서도 상세한 거래 내용을 하나하나 블록체인에 기록하지 않는다. 데이터의 이동은 체인 밖에서 이뤄지고, 거래 대금 결제도 블록체인과는 별도의 시스템 상에서 이뤄지게 함으로써 메디블록의 암호화폐 이외의 결제 수단이 활용될 수 있는 여지를 만들고, 데이터 원본을 가지고 있지 않은 사람이 블록체인을 통해 타인의 프라이버시를 침해하는 수준의 정보를 취득하지 못하도록 한다.
마지막으로, 사용자의 개인 정보는 블록체인 상에 기록되지 않으며 헬스케어 데이터도 머클 트리를 활용해 비식별화한 후 공유하는 것이 가능하기 때문에 사용자의 익명성이 보장된다.

## 결론

메디블록 플랫폼은 사용자의 의료 데이터가 본인의 완전한 컨트롤 하에 관리되고 활용될 수 있도록, 블록체인 기술을 핵심 기반으로 하여 다양한 컴포넌트들로 구성된다. 메디블록 플랫폼의 최종 목표는 기술을 통해 완전한 환자 중심 헬스케어 생태계를 실현하는 것이며, 검증과 수정을 반복하여 현재보다 나은 형태로 바꿔나가는 일은 여전히 진행 중이다.
